# Maybe we count every time we PASS through 0, not just land on it
# Example: rotating from 50 right 68 -> lands on 18 after wrapping
# During this rotation we pass through: 51..99(99 stops), then wrap and go 0,1..18
# So we pass through 0 once

let initial_state = {position: 50, times_at_zero: 0} in

let process_line = \state \line
  if is_empty (trim line) then
    state
  else
    let dir = head (to_list line) in
    let amount_str = join (tail (to_list line)) "" in
    let amount = to_int amount_str in
    let current_position = to_int (get state "position") in
    let current_times = to_int (get state "times_at_zero") in
    
    let new_position_raw = if dir == "R" then 
      current_position + amount 
    else 
      current_position - amount 
    in
    
    # Count 0-crossings, but NOT when we land exactly on 0
    # We pass through 0, but don't count landing on 0 twice
    let times_at_zero = if dir == "R" then
      # How many multiples of 100 do we pass through?
      # 50 + 68 = 118: we pass 100, so 1 time
      # But if we land exactly on 0 (118 % 100 == 18), don't double-count
      let raw_count = (current_position + amount) / 100 in
      let lands_on_zero = if (current_position + amount) % 100 == 0 then 1 else 0 in
      raw_count - lands_on_zero
    else
      # Going left from position P by amount A:
      let final_raw = new_position_raw in
      if final_raw < 0 then
        # Count wraps
        let raw_count = (0 - final_raw) / 100 in
        let lands_on_zero = if final_raw % 100 == 0 then 1 else 0 in
        raw_count - lands_on_zero
      else
        0
    in
    
    let incremented_times = current_times + times_at_zero in
    
    let k = new_position_raw in
    let final_position = if k < 0 then 
      100 + (k % 100)
    else if k > 99 then
      k % 100
    else
      k
    in
    
    {position: final_position, times_at_zero: incremented_times}
in

let input_lines = readlines @data.txt in
let final_state = fold process_line initial_state input_lines in

trace "Times at zero" (get final_state "times_at_zero")
