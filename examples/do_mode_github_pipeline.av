# Do Mode: Advanced Deployment Pipeline
#
# Demonstrates multi-stage deployment pipeline with:
# - Environment-based configuration (staging vs production)
# - Multi-stage workflow (build â†’ test â†’ deploy)
# - Health checks and validation
#
# Usage:
#   avon do deploy_staging
#   avon do deploy_production
#   avon do status

{
  validate_manifest: {
    cmd: [
      "echo 'ğŸ“‹ Validating manifest...'",
      "test -f deployment.yaml || (echo 'ERROR: deployment.yaml not found' && exit 1)",
      "echo 'âœ… Valid'"
    ],
    desc: "Verify deployment manifest"
  },

  check_docker: {
    cmd: [
      "echo 'ğŸ” Checking Docker...'",
      "docker info > /dev/null 2>&1 || (echo 'ERROR: docker not available' && exit 1)",
      "echo 'âœ… Docker ready'"
    ],
    desc: "Verify Docker is available"
  },

  check_kubernetes: {
    cmd: [
      "echo 'ğŸ” Checking Kubernetes...'",
      "kubectl version > /dev/null 2>&1 || (echo 'ERROR: kubectl not available' && exit 1)",
      "echo 'âœ… Kubernetes ready'"
    ],
    desc: "Verify kubectl is available"
  },

  pre_flight: {
    cmd: [
      "echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'",
      "echo 'Pre-flight checks complete'",
      "echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'"
    ],
    deps: ["validate_manifest", "check_docker", "check_kubernetes"],
    desc: "All pre-flight checks"
  },

  build_image: {
    cmd: [
      "echo 'ğŸ”¨ Building Docker image...'",
      "docker build -t " + ":latest .",
      "echo 'âœ… Built'"
    ],
    deps: ["pre_flight"],
    desc: "Build Docker image"
  },

  push_image: {
    cmd: [
      "echo 'ğŸ“¤ Pushing image...'",
      "docker push " + ":latest",
      "echo 'âœ… Pushed'"
    ],
    deps: ["build_image"],
    desc: "Push Docker image to registry"
  },

  deploy_staging: {
    cmd: [
      "echo 'ğŸš€ Deploying to STAGING...'",
      "echo '  Domain: " + "'",
      "echo '  Replicas: " + "'",
      "kubectl apply -f deployment.yaml --namespace=staging",
      "kubectl rollout status deployment/app -n staging",
      "echo 'âœ… Deployed'"
    ],
    deps: ["push_image"],
    desc: "Deploy to staging"
  },

  test_staging: {
    cmd: [
      "echo 'ğŸ¥ Testing staging...'",
      "sleep 5",
      "curl -f https://" + "/health || (echo 'Health check failed' && exit 1)",
      "echo 'âœ… Healthy'"
    ],
    deps: ["deploy_staging"],
    desc: "Verify staging is healthy"
  },

  deploy_production: {
    cmd: [
      "echo 'ğŸš€ Deploying to PRODUCTION...'",
      "echo '  Domain: " + "'",
      "echo '  Replicas: " + "'",
      "kubectl apply -f deployment.yaml --namespace=production",
      "kubectl rollout status deployment/app -n production",
      "echo 'âœ… Deployed'"
    ],
    deps: ["test_staging"],
    desc: "Deploy to production"
  },

  test_production: {
    cmd: [
      "echo 'ğŸ¥ Testing production...'",
      "sleep 5",
      "curl -f https://" + "/health || (echo 'Health check failed' && exit 1)",
      "echo 'âœ… Healthy'"
    ],
    deps: ["deploy_production"],
    desc: "Verify production is healthy"
  },

  deploy_all: {
    cmd: [
      "echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'",
      "echo 'Deployment Complete'",
      "echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'",
      "echo 'Environment: " + "'",
      "echo 'Domain: " + "'",
      "echo 'âœ… All checks passed'"
    ],
    deps: ["test_production"],
    desc: "Complete deployment pipeline"
  },

  rollback: {
    cmd: [
      "echo 'â®ï¸  Rolling back...'",
      "kubectl rollout undo deployment/app --namespace=",
      "echo 'âœ… Rolled back'"
    ],
    desc: "Rollback to previous version"
  },

  status: {
    cmd: [
      "echo 'ğŸ“Š Deployment Status'",
      "kubectl get deployments --namespace=",
      "echo ''",
      "kubectl get pods --namespace=",
      "echo ''",
      "kubectl get services --namespace="
    ],
    desc: "Show current status"
  },

  logs: {
    cmd: "kubectl logs -l app=myapp --namespace=" + " -f",
    desc: "Stream application logs"
  }
}
