# Do Mode: Remote Software Installation Recipe
#
# Demonstrates idempotent software installation with:
# - Pre-flight checks (verify prerequisites)
# - Idempotent installation (safe to run multiple times)
# - Verification steps (ensure installation succeeded)
#
# Usage:
#   avon do all_rust --git user/avon-recipes/rust.av --force
#   avon do install_dev_tools --git user/avon-recipes/rust.av --force

{
  check_curl: {
    cmd: "command -v curl > /dev/null || (echo 'ERROR: curl not found' && exit 1)",
    desc: "Verify curl is installed"
  },

  check_not_installed: {
    cmd: "test ! -f ~/.cargo/bin/rustc || (echo 'INFO: Rust already installed' && exit 0)",
    desc: "Check if Rust is already installed"
  },

  verify_prerequisites: {
    cmd: "echo 'âœ… All prerequisites met, ready to install'",
    deps: ["check_curl", "check_not_installed"],
    desc: "Verify all prerequisites"
  },

  install_rust: {
    cmd: [
      "echo 'ğŸš€ Installing Rust...'",
      "curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y",
      "echo 'âœ… Installation complete'"
    ],
    deps: ["verify_prerequisites"],
    desc: "Download and run Rust installer"
  },

  configure_shell: {
    cmd: [
      "echo 'ğŸ”§ Configuring shell...'",
      "if [ -f ~/.bash_profile ]; then source ~/.bash_profile; fi",
      "if [ -f ~/.bashrc ]; then source ~/.bashrc; fi",
      "if [ -f ~/.zshrc ]; then source ~/.zshrc; fi"
    ],
    deps: ["install_rust"],
    desc: "Load environment variables"
  },

  verify_rust: {
    cmd: [
      "echo 'ğŸ” Verifying Rust...'",
      "rustc --version",
      "cargo --version",
      "rustup --version",
      "echo 'âœ… Verified successfully'"
    ],
    desc: "Verify installation succeeded"
  },

  verify_toolchain: {
    cmd: [
      "echo 'Checking toolchain...'",
      "rustup toolchain list",
      "rustup target list | grep installed"
    ],
    deps: ["verify_rust"],
    desc: "Check installed toolchains"
  },

  all_rust: {
    cmd: [
      "echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'",
      "echo 'Rust Installation Pipeline'",
      "echo 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”'"
    ],
    deps: ["verify_toolchain"],
    desc: "Complete Rust installation pipeline"
  },

  uninstall_rust: {
    cmd: [
      "echo 'âš ï¸  Uninstalling Rust...'",
      "rustup self uninstall -y",
      "echo 'âœ… Uninstalled'"
    ],
    desc: "Uninstall Rust"
  },

  install_web_assembly: {
    cmd: [
      "echo 'ğŸ“¦ Installing WebAssembly...'",
      "rustup target add wasm32-unknown-unknown",
      "echo 'âœ… Added'"
    ],
    deps: ["verify_rust"],
    desc: "Add WebAssembly support"
  },

  install_nightly: {
    cmd: [
      "echo 'ğŸ“¦ Installing nightly...'",
      "rustup toolchain install nightly",
      "echo 'âœ… Installed'"
    ],
    deps: ["verify_rust"],
    desc: "Install nightly toolchain"
  },

  install_dev_tools: {
    cmd: [
      "echo 'ğŸ“¦ Installing dev tools...'",
      "rustup component add clippy rustfmt",
      "echo 'âœ… Installed'"
    ],
    deps: ["verify_rust"],
    desc: "Install clippy and rustfmt"
  }
}
